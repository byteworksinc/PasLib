 MACRO&LAB EXPAND_DEVICE &DCB&LAB ~SETM JSL $E100A8 DC I2'$0114' DC I4'&DCB' ~RESTM MEND MACRO&lab error &e&lab ph2 &e jsl SystemError mend MACRO&LAB SUB &P,&W&LAB ANOP LCLA &PC LCLC &N LCLC &S LCLC &PR LCLC &C GBLA &DISP GBLA &WS&WS SETA &W&PC SETA 1&DISP SETA 3+&W.A&PR SETC &P(&PC)&C AMID &PR,2,1 AIF "&C"=":",.B&S AMID &PR,1,2&N AMID &PR,4,L:&PR-2 AGO .C.B&S AMID &PR,1,1&N AMID &PR,3,L:&PR-2.C&N EQU &DISP&DISP SETA &DISP+&S&PC SETA &PC+1 AIF &PC<=C:&P,^A TDC TAX TSC SEC SBC #&W-1 TCD DEC A TCS PHX MEND MACRO&LAB RETURN &N&LAB LDA &WS+1 STA &DISP-2 LDA &WS STA &DISP-3 CLC TDC ADC #&DISP-4 PLD TCS AIF C:&N=0,.B AIF &N<>2,.A TXA AGO .B.A MNOTE 'Return values other than 2 not supported'.B RTL MEND MACRO&LAB MOVE4 &F,&T&LAB ~SETM LDA 2+&F STA 2+&T LDA &F STA &T ~RESTM MEND MACRO&LAB DW &ADR&LAB DC I1"L:SYSA&SYSCNT"SYSA&SYSCNT DC C"&ADR" MEND MACRO&LAB PH2 &N1 LCLC &C&LAB ANOP&C AMID &N1,1,1 AIF "&C"="#",.D AIF S:LONGA=1,.A REP #%00100000.A AIF "&C"<>"{",.B&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.G&N1 AMID &N1,2,L:&N1-2 LDA (&N1) PHA AGO .E.B LDA &N1 PHA AGO .E.D&N1 AMID &N1,2,L:&N1-1 PEA &N1 AGO .F.E AIF S:LONGA=1,.F SEP #%00100000.F MEXIT.G MNOTE "Missing closing '}'",16 MEND MACRO&LAB PH4 &N1 LCLC &C&LAB ANOP&C AMID &N1,1,1 AIF "&C"="#",.D AIF S:LONGA=1,.A REP #%00100000.A AIF "&C"<>"{",.B&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.G&N1 AMID &N1,2,L:&N1-2 LDY #2 LDA (&N1),Y PHA LDA (&N1) PHA AGO .E.B AIF "&C"<>"[",.C LDY #2 LDA &N1,Y PHA LDA &N1 PHA AGO .E.C LDA &N1+2 PHA LDA &N1 PHA AGO .E.D&N1 AMID &N1,2,L:&N1-1 PEA +(&N1)|-16 PEA &N1 AGO .F.E AIF S:LONGA=1,.F SEP #%00100000.F MEXIT.G MNOTE "Missing closing '}'",16 MEND MACRO&LAB ~SETM&LAB ANOP AIF C:&~LA,.B GBLB &~LA GBLB &~LI.B&~LA SETB S:LONGA&~LI SETB S:LONGI AIF S:LONGA.AND.S:LONGI,.A REP #32*(.NOT.&~LA)+16*(.NOT.&~LI) LONGA ON LONGI ON.A MEND MACRO&LAB ~RESTM&LAB ANOP AIF (&~LA+&~LI)=2,.I SEP #32*(.NOT.&~LA)+16*(.NOT.&~LI) AIF &~LA,.H LONGA OFF.H AIF &~LI,.I LONGI OFF.I MEND MACRO&LAB ADD4 &M1,&M2,&M3 LCLB &YISTWO LCLC &C&LAB ~SETM AIF C:&M3,.A&C AMID "&M2",1,1 AIF "&C"<>"#",.A&C AMID "&M1",1,1 AIF "&C"="{",.A AIF "&C"="[",.A&C AMID "&M2",2,L:&M2-1 AIF &C>=65536,.A CLC ~LDA &M1 ~OP ADC,&M2 ~STA &M1 BCC ~&SYSCNT ~OP.H INC,&M1~&SYSCNT ANOP AGO .C.A AIF C:&M3,.B LCLC &M3&M3 SETC &M1.B CLC ~LDA &M1 ~OP ADC,&M2 ~STA &M3 ~LDA.H &M1 ~OP.H ADC,&M2 ~STA.H &M3.C ~RESTM MEND MACRO&LAB SUB4 &M1,&M2,&M3 LCLB &YISTWO LCLC &C&LAB ~SETM AIF C:&M3,.A&C AMID "&M2",1,1 AIF "&C"<>"#",.A&C AMID "&M1",1,1 AIF "&C"="{",.A AIF "&C"="[",.A&C AMID "&M2",2,L:&M2-1 AIF &C>=65536,.A SEC ~LDA &M1 ~OP SBC,&M2 ~STA &M1 BCS ~&SYSCNT ~OP.H DEC,&M1~&SYSCNT ANOP AGO .C.A AIF C:&M3,.B LCLC &M3&M3 SETC &M1.B SEC ~LDA &M1 ~OP SBC,&M2 ~STA &M3 ~LDA.H &M1 ~OP.H SBC,&M2 ~STA.H &M3.C ~RESTM MEND MACRO&LAB CREATE &DCB&LAB JSL $E100A8 DC I2'$01' DC I4'&DCB' MEND MACRO&LAB DESTROY &DCB&LAB JSL $E100A8 DC I2'$02' DC I4'&DCB' MEND MACRO&LAB GET_FILE_INFO &DCB&LAB JSL $E100A8 DC I2'$06' DC I4'&DCB' MEND MACRO&LAB OPEN &DCB&LAB JSL $E100A8 DC I2'$10' DC I4'&DCB' MEND MACRO&LAB READ &DCB&LAB JSL $E100A8 DC I2'$12' DC I4'&DCB' MEND MACRO&LAB CLOSE &DCB&LAB JSL $E100A8 DC I2'$14' DC I4'&DCB' MEND MACRO&LAB SET_MARK &DCB&LAB JSL $E100A8 DC I2'$16' DC I4'&DCB' MEND MACRO&LAB SET_EOF &DCB&LAB JSL $E100A8 DC I2'$18' DC I4'&DCB' MEND MACRO&LAB DBNE &R,&BP AIF "&R"="X",.L1 AIF "&R"="Y",.L1&LAB DEC &R BNE &BP MEXIT.L1&LAB DE&R BNE &BP MEND MACRO&LAB JEQ &BP&LAB BNE *+5 BRL &BP MEND MACRO&LAB LLA &AD1,&AD2&LAB ANOP LCLA &L LCLB &LA AIF S:LONGA,.A REP #%00100000 LONGA ON&LA SETB 1.A LDA #&AD2&L SETA C:&AD1.B STA &AD1(&L)&L SETA &L-1 AIF &L,^B LDA #^&AD2&L SETA C:&AD1.C STA 2+&AD1(&L)&L SETA &L-1 AIF &L,^C AIF &LA=0,.D SEP #%00100000 LONGA OFF.D MEND MACRO&LAB LONG &A,&B LCLB &I LCLB &M&A AMID &A,1,1&M SETB "&A"="M"&I SETB "&A"="I" AIF C:&B=0,.A&B AMID &B,1,1&M SETB ("&B"="M").OR.&M&I SETB ("&B"="I").OR.&I.A&LAB REP #&M*32+&I*16 AIF .NOT.&M,.B LONGA ON.B AIF .NOT.&I,.C LONGI ON.C MEND MACRO&LAB SHORT &A,&B LCLB &I LCLB &M&A AMID &A,1,1&M SETB "&A"="M"&I SETB "&A"="I" AIF C:&B=0,.A&B AMID &B,1,1&M SETB ("&B"="M").OR.&M&I SETB ("&B"="I").OR.&I.A&LAB SEP #&M*32+&I*16 AIF .NOT.&M,.B LONGA OFF.B AIF .NOT.&I,.C LONGI OFF.C MEND MACRO&LAB ~OP.H &OPC,&OP&LAB ANOP LCLC &C&C AMID "&OP",1,1 AIF "&C"="[",.B AIF "&C"<>"{",.D&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B AIF &YISTWO,.C&YISTWO SETB 1 LDY #2&OP SETC "&OP,Y".C &OPC &OP MEXIT.D AIF "&C"<>"#",.E&OP AMID "&OP",2,L:&OP-1&OP SETC "#^&OP" &OPC &OP MEXIT.E &OPC 2+&OP MEND MACRO&LAB ~LDA.H &OP&LAB ANOP LCLC &C&C AMID "&OP",1,1 AIF "&C"="[",.B AIF "&C"<>"{",.D&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B AIF &YISTWO,.C&YISTWO SETB 1 LDY #2&OP SETC "&OP,Y".C LDA &OP MEXIT.D AIF "&C"<>"#",.E&OP AMID "&OP",2,L:&OP-1&OP SETC "#^&OP" LDA &OP MEXIT.E LDA 2+&OP MEND MACRO&LAB ~STA.H &OP&LAB ANOP LCLC &C&C AMID "&OP",1,1 AIF "&C"="[",.B AIF "&C"<>"{",.D&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B AIF &YISTWO,.C&YISTWO SETB 1 LDY #2&OP SETC "&OP,Y".C STA &OP MEXIT.D STA 2+&OP MEND MACRO&LAB ~LDA &OP LCLC &C&C AMID "&OP",1,1 AIF "&C"<>"{",.B&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B&LAB LDA &OP MEND MACRO&LAB ~STA &OP LCLC &C&C AMID "&OP",1,1 AIF "&C"<>"{",.B&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B&LAB STA &OP MEND MACRO&LAB ~OP &OPC,&OP LCLC &C&C AMID "&OP",1,1 AIF "&C"<>"{",.B&C AMID "&OP",L:&OP,1 AIF "&C"="}",.A MNOTE "Missing closing '}'",2&OP SETC &OP}.A&OP AMID "&OP",2,L:&OP-2&OP SETC (&OP).B&LAB &OPC &OP MEND MACRO&LAB PUTC &N1,&F1,&CR,&ERROUT AIF C:&F1,.A LCLC &F1&F1 SETC #0.A&LAB ~SETM PH2 &N1 PH2 &F1 PH2 #C:&CR PH2 #C:&ERROUT JSL ~PUTC ~RESTM MEND MACRO&LAB PUTCR &ERROUT&LAB ~SETM AIF C:&ERROUT,.A PEA $0D JSL SysCharOut PEA $0A JSL SysCharOut AGO .B.A PEA $0D JSL SysCharErrout PEA $0A JSL SysCharErrout.B               ~RESTM MEND MACRO&LAB WRITE &DCB&LAB JSL $E100A8 DC I2'$13' DC I4'&DCB' MEND MACRO&LAB BLE &BP&LAB BLT &BP BEQ &BP MEND MACRO&LAB GET_PREFIX &DCB&LAB JSL $E100A8 DC I2'$0A' DC I4'&DCB' MEND MACRO&LAB JCS &BP&LAB BCC *+5 BRL &BP MEND MACRO&LAB _DEC2INT&LAB LDX #$280B JSL $E10000 MEND MACRO&LAB MUL4 &N1,&N2,&N3&LAB ~SETM PH4 &N1 PH4 &N2 JSL ~MUL4 AIF C:&N3,.A PL4 &N1 AGO .B.A PL4 &N3.B ~RESTM MEND MACRO&LAB PL4 &N1 LCLC &C&LAB ANOP AIF S:LONGA=1,.A REP #%00100000.A&C AMID &N1,1,1 AIF "&C"<>"{",.B&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.F&N1 AMID &N1,2,L:&N1-2 PLA STA (&N1) LDY #2 PLA STA (&N1),Y AGO .D.B AIF "&C"<>"[",.C PLA STA &N1 LDY #2 PLA STA &N1,Y AGO .D.C PLA STA &N1 PLA STA &N1+2.D AIF S:LONGA=1,.E SEP #%00100000.E MEXIT.F MNOTE "Missing closing '}'",16 MEND MACRO&LAB MOVE &AD1,&AD2,&LEN&LAB ANOP LCLB &LA LCLB &LI LCLC &C AIF C:&LEN,.A1 LCLC &LEN&LEN SETC #2.A1&LA SETB S:LONGA&LI SETB S:LONGI AIF S:LONGA.AND.S:LONGI,.A REP #32*(.NOT.&LA)+16*(.NOT.&LI) LONGA ON LONGI ON.A&C AMID &LEN,1,1 AIF "&C"<>"#",.D&C AMID &LEN,2,L:&LEN-1 AIF &C<>2,.D&C AMID &AD1,1,1 AIF "&C"<>"{",.B&AD1 AMID &AD1,2,L:&AD1-2&AD1 SETC (&AD1).B LDA &AD1&C AMID &AD2,1,1 AIF "&C"<>"{",.C&AD2 AMID &AD2,2,L:&AD2-2&AD2 SETC (&AD2).C STA &AD2 AGO .G.D&C AMID &AD1,1,1 AIF "&C"="#",.F&C AMID &LEN,1,1 AIF "&C"<>"{",.E&LEN AMID &LEN,2,L:&LEN-2&LEN SETC (&LEN).E&C AMID &LEN,1,1 AIF "&C"="#",.E1 LDA &LEN DEC A AGO .E2.E1 LDA &LEN-1.E2 LDX #&AD1 LDY #&AD2 MVN &AD1,&AD2 AGO .G.F LDA &AD1 STA &AD2 LDA &LEN-2 LDX #&AD2 LDY #&AD2+1 MVN &AD2,&AD2.G AIF (&LA+&LI)=2,.I SEP #32*(.NOT.&LA)+16*(.NOT.&LI) AIF &LA,.H LONGA OFF.H AIF &LI,.I LONGI OFF.I MEND MACRO&LAB DISPOSE &PTR&LAB PH4 &PTR JSL ~DISPOSE MEND MACRO&LAB NEW &ADDR,&LEN&LAB PH4 &LEN JSL ~NEW STA &ADDR STX &ADDR+2 MEND MACRO&LAB PL2 &N1 LCLC &C&LAB ANOP AIF S:LONGA=1,.A REP #%00100000.A&C AMID &N1,1,1 AIF "&C"<>"{",.B&C AMID &N1,L:&N1,1 AIF "&C"<>"}",.F&N1 AMID &N1,2,L:&N1-2 PLA STA (&N1) AGO .D.B PLA STA &N1.D AIF S:LONGA=1,.E SEP #%00100000.E MEXIT.F MNOTE "Missing closing '}'",16 MEND MACRO&LAB INC4 &A&LAB ~SETM INC &A BNE ~&SYSCNT INC 2+&A~&SYSCNT ~RESTM MEND MACRO&LAB GET_MARK &DCB&LAB JSL $E100A8 DC I2'$17' DC I4'&DCB' MEND MACRO&LAB GET_EOF &DCB&LAB JSL $E100A8 DC I2'$19' DC I4'&DCB' MEND MACRO&LAB BGT &BP&LAB BEQ *+4 BGE &BP MEND MACRO&LAB SEED &N1&LAB ANOP LCLB &LA AIF S:LONGA,.A REP #%00100000 LONGA ON&LA SETB 1.A DC R"~RANX" AIF C:&N1=0,.C LCLC &C&C AMID &N1,1,1 AIF "&C"<>"{",.B&N1 AMID &N1,2,L:&N1-2&N1 SETC (&N1).B LDA &N1 AGO .D.C LDA >$4E.D JSL ~RANX2 AIF &LA=0,.E SEP #%00100000 LONGA OFF.E MEND MACRO&LAB JGE &BP&LAB BLT *+5 BRL &BP MEND MACRO&LAB _DEC2LONG&LAB LDX #$290B JSL $E10000 MEND MACRO&LAB _LONG2DEC&LAB LDX #$270B JSL $E10000 MEND MACRO&LAB REDIRECT &DCB&LAB ~SETM JSL $E100A8 DC I2'$0110' DC I4'&DCB' ~RESTM MEND MACRO&LAB DEC4 &A&LAB ~SETM LDA &A BNE ~&SYSCNT DEC 2+&A~&SYSCNT DEC &A ~RESTM MEND